<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>酒店業績儀表板</title>

  <!-- 引入 Chart.js (繪製圖表用) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* 全域字型與頁面設定 */
body { 
  margin: 0;
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Noto Sans", sans-serif;
  background: #0f172a;       /* 深靛藍背景 */
  color: #111827;
}

/* 頁首 header 區域 */
header { 
  padding: 18px 0;
  border-bottom: 1px solid rgba(148,163,184,0.4);
  background: rgba(15,23,42,0.96);   /* 深色半透明 */
  backdrop-filter: blur(10px);       /* 玻璃感 */
  position: sticky;
  top: 0;
  z-index: 1000;
  box-shadow: 0 10px 30px rgba(15,23,42,0.5);
}


    /* wrap：最大寬度限制，置中 */
.wrap { 
  max-width: 1360px;
  margin: 0 auto;
  padding: 18px 20px;
  box-sizing: border-box;
}

    /* 頂端列：左側三條槓 + 右側標題 */
    .top-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

/* 標題字型大小 */
h1 { 
  font-size: 20px;
font-weight: 600;
  margin: 0;
  flex: 1;
  color: #e5e7eb;               /* 淺色字 */
  letter-spacing: 0.04em;
}

    /* 三條槓按鈕（預設桌機隱藏） */
    .menu-toggle {
  display: none;
  width: 34px;
  height: 30px;
  border-radius: 999px;
  border: 1px solid rgba(148,163,184,0.7);
  background: radial-gradient(circle at top, #020617 0, #020617 60%, #020617 100%);
  padding: 4px 6px;
  box-sizing: border-box;
  cursor: pointer;
  align-items: center;
  justify-content: center;
  box-shadow: 0 8px 22px rgba(15,23,42,0.9);
}
.menu-toggle span {
  display: block;
  width: 100%;
  height: 2px;
  background: #e5e7eb;
  margin: 3px 0;
  transition: transform 0.2s, opacity 0.2s;
}

    /* 開啟狀態的三條槓變成 X（可有可無） */
    body.menu-open .menu-toggle span:nth-child(1) {
      transform: translateY(5px) rotate(45deg);
    }
    body.menu-open .menu-toggle span:nth-child(2) {
      opacity: 0;
    }
    body.menu-open .menu-toggle span:nth-child(3) {
      transform: translateY(-5px) rotate(-45deg);
    }

    /* 篩選器區域：設定 6 欄格局，並加上間距 */
    .filters { 
      display: grid;
      grid-template-columns: repeat(6, minmax(140px, 1fr));
      gap: 12px;
    }

    /* 篩選器內每個卡片 */
.card { 
  background: radial-gradient(circle at top, #0b1220 0, #020617 55%, #020617 100%);
  border: 1px solid rgba(148,163,184,0.35);
  border-radius: 12px;
  padding: 10px 12px;
  box-shadow: 0 10px 30px rgba(15,23,42,0.55);
}

    /* 卡片內的標籤文字 */
label { 
  display: block;
  font-size: 11px;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  color: #9ca3af;
  margin: 0 0 6px;
}

    /* 下拉選單 */
select { 
  width: 100%;
  background: linear-gradient(135deg, #020617 0, #020617 60%, #020617 100%);
  color: #e5e7eb;
  border: 1px solid rgba(148,163,184,0.6);
  border-radius: 999px;
  padding: 8px 14px;
  font-size: 13px;
  appearance: none;
  outline: none;
  box-shadow: 0 6px 18px rgba(15,23,42,0.7);
}

    /* 表格 */
table { 
  width: 100%;
  border-collapse: collapse;
  background: #020617;
  border-radius: 16px;
  overflow: hidden;
  border: 1px solid rgba(148,163,184,0.4);
  margin-top: 14px;
}

/* 表頭 thead 樣式 */
thead th { 
  text-align: left;
  font-weight: 600;
  font-size: 12px;
  color: #e5e7eb;
  background: radial-gradient(circle at top, #111827 0, #020617 60%);
  padding: 8px 10px;
  border-bottom: 1px solid rgba(55,65,81,0.9);
}

/* 表格內容列 tbody */
tbody td { 
  padding: 7px 10px;
  border-bottom: 1px solid rgba(31,41,55,0.85);
  font-size: 12px;
  color: #e5e7eb;
}

/* 隔行底色 */
tbody tr:nth-child(odd) {
  background: rgba(15,23,42,0.8);
}
tbody tr:nth-child(even) {
  background: rgba(15,23,42,0.6);
}

/* 計算欄位 calc 樣式 */
td.calc {
  background: rgba(56,189,248,0.1);
  color: #38bdf8;
  font-weight: 600;
}

/* hover */
tbody tr:hover { 
  background: rgba(15,23,42,0.95);
}

/* 表尾 (tfoot) 樣式 */
tfoot td { 
  padding: 9px 10px;
  background: #020617;
  color: #f9fafb;
  border-top: 1px solid rgba(148,163,184,0.7);
  font-weight: 600;
  font-size: 12px;
}

/* 數字欄位靠右對齊 */
td.num, th.num { 
  text-align: right;
}


    /* 備註區 note */
    .note { 
      margin-top: 8px;
      font-size: 14px;
      color: #666;
    }

    /* charts 區域：左右並排 */
    .charts { 
      display: flex;
      gap: 20px;
      margin: 20px 0;
    }

.chart-left, 
.chart-right { 
  border-radius: 18px;
  padding: 14px 16px;
  display: flex;
  flex-direction: column;
  align-items: stretch;
  justify-content: flex-start;
  background: radial-gradient(circle at top, #020617 0, #020617 55%, #020617 100%);
  border: 1px solid rgba(148,163,184,0.45);
  box-shadow: 0 20px 45px rgba(15,23,42,0.9);
}

.chart-left { 
  flex: 3;
  order: 1;
}

.chart-right { 
  flex: 6;
  order: 2;
}

/* 圖表標題文字 */
.chart-left h2, .chart-right h2 { 
  font-size: 14px;
  margin: 4px 0 10px;
  text-align: left;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: #9ca3af;
}


    /* 圓餅圖 canvas 自適應 */
    .chart-left canvas {
      width: 100% !important;   /* 寬度隨容器調整 */
      height: auto !important;  /* 高度保持比例 */
      max-width: none;          /* 不限制最大寬度 */
    }

    /* 折線圖 canvas 自適應（讓 Chart.js 控制高度比例）*/
    .chart-right canvas {
      width: 100% !important;
      /* 刪掉 height: auto !important; */
    }

    /* 圖表標題文字 */
    .chart-left h2, .chart-right h2 { 
      font-size: 16px;
      margin: 6px 0;
      text-align: center;
    }

    /* 載入中遮罩層：深色版 */
#loadingOverlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(15,23,42,0.96);      /* 深藍透明 */
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1100;                         /* 比 header 再高一點 */
}

/* 載入方塊內容 */
.loadingBox { 
  text-align: center; 
  font-size: 15px; 
  color: #e5e7eb;                        /* 淺字 */
}

/* 進度條外框 */
.progress-bar {
  margin-top: 10px;
  width: 220px;
  height: 10px;
  background: rgba(30,64,175,0.5);       /* 深藍 */
  border-radius: 999px;
  overflow: hidden;
}

/* 進度條填充 */
.progress-fill {
  width: 0%;   /* 預設 0% */
  height: 100%;
  background: linear-gradient(90deg, #38bdf8, #22c55e);  /* 藍綠漸層 */
  animation: fillBar 2.5s forwards;
}


    /* 動畫 keyframes：從 0% → 100% */
    @keyframes fillBar {
      from { width: 0%; }
      to   { width: 100%; }
    }

    /* 自訂下拉 + checkbox 清單 */
    .dropdown { position: relative; }
    .dropdown button {
  width: 100%;
  background: linear-gradient(135deg, #020617 0, #020617 60%, #020617 100%);
  border: 1px solid rgba(148,163,184,0.6);
  border-radius: 999px;
  padding: 8px 14px;
  font-size: 13px;
  text-align: left;
  color: #e5e7eb;
  box-shadow: 0 6px 18px rgba(15,23,42,0.7);
}
.dropdown-content {
  display: none;
  position: absolute;
  top: calc(100% + 4px);
  left: 0;
  right: 0;
  background: #020617;
  border: 1px solid rgba(148,163,184,0.65);
  border-radius: 10px;
  max-height: 220px;
  overflow-y: auto;
  z-index: 20;
  box-shadow: 0 18px 40px rgba(15,23,42,0.9);
}
.dropdown-content label {
  display: block;
  padding: 6px 10px;
  cursor: pointer;
  color: #e5e7eb;
}
.dropdown-content label:hover {
  background: rgba(148,163,184,0.16);
}

    .dropdown-content label {
      display: block;
      padding: 4px 8px;
      cursor: pointer;
    }
    .dropdown.show .dropdown-content { display: block; }

    /* 手機版：側邊欄遮罩（點一下可以關閉菜單） */
    #sideOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      z-index: 800;  /* 在 main 上面、header 下面 */
    }

/* 手機專用按鈕：預設隱藏，手機才顯示 */
.mobile-only {
  display: none;
}

/* 手機版：其他欄位預設隱藏，展開時顯示 */

/* X 關閉按鈕：預設桌機不顯示 */
.close-filter-btn {
  display: none;
}

/* 手機版側邊欄右上角的 X */
@media (max-width: 768px) {
  .close-filter-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    position: absolute;
    top: 16px;
    right: 14px;
    width: 32px;
    height: 32px;
    border-radius: 999px;
    border: 1px solid rgba(148,163,184,0.5);
    background: rgba(2,6,23,0.9);
    color: #e5e7eb;
    font-size: 22px;
    line-height: 1;
    cursor: pointer;
    box-shadow: 0 6px 16px rgba(0,0,0,0.45);
    z-index: 1300;
  }

  .close-filter-btn:hover {
    background: rgba(30,41,59,0.9);
  }
}
@media (max-width: 768px) {
  .mobile-only {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 6px 12px;
    border-radius: 999px;
    border: 1px solid rgba(148,163,184,0.7);
    background: radial-gradient(circle at top, #020617 0, #020617 60%, #020617 100%);
    color: #e5e7eb;
    font-size: 12px;
    box-shadow: 0 8px 20px rgba(15,23,42,0.9);
  }

  .mobile-extra {
    display: none;
  }

  body.show-more-cols .mobile-extra {
    display: table-cell;
  }
}


    /* === 手機板調整 === */
    @media (max-width: 768px) {
      header {
        padding: 10px 0;
      }

      .wrap {
        padding: 10px 12px;
      }

      /* 三條槓在手機顯示 */
      .menu-toggle {
        display: inline-flex;
      }

      /* charts 區域上下堆疊 */
      .charts { 
        flex-direction: column; 
      }

      /* 折線圖在上，單獨佔一列，避免被壓縮 */
      .chart-right {
        order: 1;
        flex: none;
        width: 95%;
        margin: 0 auto;
      }
      .chart-right canvas { width: 100% !important; }

      /* 圓餅圖在下，縮小置中 */
      .chart-left {
        order: 2;
        flex: none;
        width: 95%;
        margin: 0 auto;
      }

      /* 標題字體縮小 */
      h1 {  
        font-size: 18px; 
      }

      /* 表格字體縮小 */
      table th, table td {  
        font-size: 11px;  
        padding: 6px; 
      }

      /* 下拉選單按鈕縮小 */
      .dropdown button {
        font-size: 13px;
        padding: 6px 8px;
      }

/* 手機：filters 變成左側滑出的深色側邊欄 */
.filters {
  position: fixed;
  top: 0;
  left: -280px;          /* 預設藏在左邊 */
  width: 260px;
  height: 100vh;
  background: radial-gradient(circle at top, #020617 0, #020617 55%, #020617 100%);
  box-shadow: 2px 0 24px rgba(15,23,42,0.95);
  padding: 60px 12px 16px 12px;  /* 上方留位置給 header */
  box-sizing: border-box;
  grid-template-columns: 1fr;    /* 一欄直排 */
  gap: 10px;
  overflow-y: auto;
  z-index: 1001;
}


      /* 開啟側邊欄時，滑出來 */
      body.menu-open .filters {
        left: 0;
        transition: left 0.2s ease-out;
      }

      /* 開啟時顯示遮罩 */
      body.menu-open #sideOverlay {
        display: block;
      }
  /* 手機版：filters 裡的每一格變成扁平樣式，不要卡片 */
  .filters .card {
    background: transparent;
    border: none;
    box-shadow: none;
    padding: 4px 0 8px 0;
  }

  .filters label {
    font-size: 11px;
    margin-bottom: 4px;
  }

  .filters select,
  .filters .dropdown button {
    border-radius: 8px;    /* 手機改成方圓角，比膠囊更省空間 */
    box-shadow: none;
    padding: 6px 10px;
    font-size: 12px;
  }

  /* 再縮小手機側邊欄的間距 & 高度 */
  .filters {
    gap: 8px !important;           /* 每個項目上下 8px */
    padding-top: 70px !important;  /* 頂部給標題 & X 的空間 */
  }

  .filters .card {
    padding: 0 !important;         /* 取消 card 額外 padding */
    margin: 0 !important;
  }

  .filters label {
    margin-bottom: 2px !important; /* label 跟選單更貼近一點 */
  }

  .filters select,
  .filters .dropdown button {
    padding: 4px 10px !important;  /* 選單高度變矮 */
    font-size: 12px !important;
  }

    }
  
/* === 手機版：縮短側邊欄各選單的間距（直排） === */
@media (max-width: 768px) {

  /* 整個側邊欄的間距縮到最小 */
  .filters {
    gap: 10px !important;       /* 每個項目之間上下約 10px */
    padding-top: 70px !important;
  }

  /* 完全去除卡片額外空間（真正讓排版變緊） */
  .filters .card {
    padding: 0 !important;
    margin: 0 !important;
    background: none !important;
    border: none !important;
    box-shadow: none !important;
  }

  /* label 與 select 的距離變最小 */
  .filters label {
    margin-bottom: 3px !important;
    font-size: 12px !important;
  }

  /* 下拉選單高度縮小、上下面更貼 */
  .filters select,
  .filters .dropdown button {
    padding: 6px 10px !important;   /* 短、薄 */
    height: 34px !important;        /* 固定高度，不會再拉太長 */
    font-size: 13px !important;
    border-radius: 8px !important;
  }
}

/* === 手機版：極縮短側邊欄空白（每項目距離 ≈ 4px）=== */
@media (max-width: 768px) {

  /* 每個選單之間只留 4px */
  .filters {
    display: flex !important;
    flex-direction: column !important;
    gap: 4px !important;   /* ← 這裡才是關鍵 */
    padding-top: 70px !important;
  }

  /* 不要 card padding/margin，避免撐開 */
  .filters .card {
    padding: 0 !important;
    margin: 0 !important;
    background: none !important;
    border: none !important;
    box-shadow: none !important;
  }

  /* label 與選單距離縮到最小 */
  .filters label {
    margin: 0 0 2px 0 !important;   /* 上0px，下2px */
    padding: 0 !important;
    line-height: 1.1 !important;
  }

  /* select 實際高度縮小 */
  .filters select,
  .filters .dropdown button {
    padding: 4px 8px !important;  /* 很薄 */
    height: 30px !important;      /* 統一固定高度 */
    font-size: 12px !important;
    line-height: 1 !important;
    border-radius: 6px !important;
  }

  /* 下拉選單的 checkbox 列表也縮小 */
  .dropdown-content label {
    padding: 4px 6px !important;
    font-size: 12px !important;
  }
}


/* === 手機版：每組之間保留「一行空白」的間隔 === */
@media (max-width: 768px) {

  /* 整體：一欄直排，每組之間約一行距離 */
  .filters {
    display: flex !important;
    flex-direction: column !important;
    gap: 10px !important;          /* 視覺上一行的空白 */
    padding-top: 70px !important;
  }

  /* 每一組（年份、月份、貨幣...）自己不要再加額外空白，只處理 label + select */
  .filters .card {
    display: flex !important;
    flex-direction: column !important;
    margin: 0 !important;
    padding: 0 !important;
    background: none !important;
    border: none !important;
    box-shadow: none !important;
  }

  /* label 緊貼上方，下面只留一點點距離給選單 */
  .filters label {
    margin: 0 0 2px 0 !important;
    padding: 0 !important;
    line-height: 1.1 !important;
  }

  /* select 本身不要有額外 margin，高度適中 */
  .filters select,
  .filters .dropdown button {
    margin: 0 !important;
    padding: 5px 10px !important;
    height: 32px !important;
    font-size: 13px !important;
    line-height: 1 !important;
    border-radius: 6px !important;
  }

  /* 下拉內容的 checkbox 也小一點 */
  .dropdown-content label {
    padding: 4px 6px !important;
    font-size: 12px !important;
  }
}

</style>
</head>

<body>
  <!-- 手機版側邊欄遮罩 -->
  <div id="sideOverlay"></div>

  <!-- 載入中遮罩畫面 -->
  <div id="loadingOverlay">
    <div class="loadingBox">
      <p>Loading...</p>
      <div class="progress-bar">
        <div class="progress-fill"></div>
      </div>
    </div>
  </div>

  <header>
    <div class="wrap">
      <!-- 上方一排：三條槓 + 標題 -->
      <div class="top-bar">
        <button class="menu-toggle" type="button" aria-label="Toggle filters">
          <span></span>
          <span></span>
          <span></span>
        </button>
        <h1 id="pageTitle">酒店業績儀表板</h1>
      </div>

      <!-- 篩選器區塊：桌機顯示在上方；手機會變成左側滑出菜單 -->
      <div class="filters">
        <!-- 手機版右上角關閉按鈕 X -->
        <button class="close-filter-btn" type="button"
                onclick="document.body.classList.remove('menu-open')">×</button>
        <!-- 年份選單 -->
        <div class="card">
          <label id="lblYear" for="yearSel">年份</label>
          <select id="yearSel"></select>
        </div>

        <!-- 月份選單 -->
        <div class="card">
          <label id="lblMonth" for="monthSel">月份</label>
          <select id="monthSel"></select>
        </div>

        <!-- 貨幣選單 -->
        <div class="card">
          <label id="lblCurrency" for="currencySel">貨幣</label>
          <select id="currencySel"></select>
        </div>

        <!-- 收入選單（改成自訂下拉 + checkbox 清單） -->
        <div class="card">
          <label id="lblMetric">收入</label>
          <div class="dropdown">
            <button id="metricBtn" type="button">Choose</button>
            <div id="metricList" class="dropdown-content"></div>
          </div>
        </div>

        <!-- 指標（住房率% / 平均房價）自訂下拉 + checkbox 清單 -->
        <div class="card">
          <label id="lblMetric2">指標</label>
          <div class="dropdown">
            <button id="indBtn" type="button">Choose</button>
            <div id="indList" class="dropdown-content"></div>
          </div>
        </div>

        <!-- 語言選單 -->
        <div class="card">
          <label id="lblLang" for="langSel">語言</label>
          <select id="langSel">
            <option value="zh">中</option>
            <option value="en">Eng</option>
            <option value="id">ID</option>
          </select>
        </div>
      </div> <!-- end .filters -->
    </div> <!-- end .wrap -->
  </header>

  <main class="wrap">
    <!-- 圖表區 -->
    <div class="charts">
      <!-- 左側：圓餅圖 -->
      <div class="chart-left">
        <h2 id="titlePie">收入來源</h2>
        <canvas id="pieChart"></canvas>
      </div>

      <!-- 右側：折線圖 -->
      <div class="chart-right">
        <h2 id="titleLine">營收/指標趨勢</h2>
        <canvas id="trendChart"></canvas>
      </div>
    </div>

    <!-- 手機版：展開/收合欄位按鈕 -->
    <button id="toggleColsBtn" class="mobile-only" style="margin-bottom:8px;">
      更多欄位 ▼
    </button>

    <!-- 資料表格 -->
    <table id="dataTable">
      <thead id="thead"></thead>
      <tbody id="tbody"></tbody>
      <tfoot id="tfoot"></tfoot>
    </table>

    <!-- 備註區 -->
    <div class="note">
      <button onclick="updateRates()" 
  style="margin-right:10px;padding:6px 14px;border-radius:999px;border:1px solid rgba(148,163,184,0.8);background:radial-gradient(circle at top,#0b1120 0,#020617 70%);color:#e5e7eb;font-size:12px;box-shadow:0 8px 22px rgba(15,23,42,0.9);">
  Update
</button>

      <span id="noteRate"></span>
    </div>
  </main>

<script>
  // ★★★ 這裡改：Google Sheet API URL ★★★
  const DATA_URL = "https://script.google.com/macros/s/AKfycbyl9w8v0HY-k4ti_I5ehGUBiYHAlQP5vP_Y-OgtuqhR5oUBEg7lKXsgrx4Z_yHM09vw/exec"; 

  // 匯率（以 IDR 為基礎），一開始給預設值，後面會自動更新
  const RATES = { 
    IDR: 1, 
    TWD: 550, 
    USD: 16590, 
    SGD: 12938 
  };

  // 記錄上次成功更新匯率的時間
  let LAST_RATE_UPDATED = null;

  // 自動更新匯率（使用 open.er-api.com）
  // API 給的是「1 IDR = 幾外幣」，我們要轉成「1 外幣 = 幾 IDR」
  async function updateRates(){
    // 先顯示載入中提示（保留舊數字）
    document.getElementById("noteRate").textContent = getNoteText(currentLang) + " → " +
      ((currentLang==="zh") ? "匯率載入中…" :
       (currentLang==="en") ? "Loading..." :
                              "Memuat...");

    try {
      const res = await fetch("https://open.er-api.com/v6/latest/IDR", { cache: "no-store" });
      const data = await res.json();

      if (data && data.result === "success" && data.rates) {
        // 將 (外幣/IDR) 取倒數成 (IDR/外幣)
        RATES.TWD = Math.round(1 / data.rates.TWD);
        RATES.USD = Math.round(1 / data.rates.USD);
        RATES.SGD = Math.round(1 / data.rates.SGD);

        // 成功才更新時間
        LAST_RATE_UPDATED = new Date();

        // 立即刷新備註（會帶上「上次更新：…」）
        document.getElementById("noteRate").textContent = getNoteText(currentLang);
      } else {
        // API 有回應但異常：保留舊時間與舊數字
        document.getElementById("noteRate").textContent = getNoteText(currentLang) + " → " +
          ((currentLang==="zh") ? "更新失敗" :
           (currentLang==="en") ? "Update failed" :
                                  "Gagal perbarui");
      }
    } catch (e) {
      console.error("更新匯率失敗:", e);
      // 連線錯誤：保留舊時間與舊數字
      document.getElementById("noteRate").textContent = getNoteText(currentLang) + " → " +
        ((currentLang==="zh") ? "更新失敗" :
         (currentLang==="en") ? "Update failed" :
                                "Gagal perbarui");
    }
  }

  // 動態產生匯率備註文字
  function getNoteText(lang){
    // 如果還沒抓到最新匯率，顯示 Loading
    if(RATES.TWD === null || RATES.USD === null || RATES.SGD === null){
      if(lang==="zh") return "匯率載入中...";
      if(lang==="en") return "Loading exchange rates...";
      if(lang==="id") return "Memuat kurs...";
    }

    // 主要文案
    let mainText = "";
    if(lang==="zh"){
      mainText = `匯率（以 IDR 為基礎）：IDR:1 → TWD:${RATES.TWD}， USD:${RATES.USD}，SGD:${RATES.SGD}`;
    } else if(lang==="en"){
      mainText = `Exchange rates (base IDR): IDR:1 → TWD:${RATES.TWD}, USD:${RATES.USD}, SGD:${RATES.SGD}`;
    } else { // id
      mainText = `Kurs (berdasar IDR): IDR:1 → TWD:${RATES.TWD}, USD:${RATES.USD}, SGD:${RATES.SGD}`;
    }

    // 上次更新時間（僅成功更新後才會有）
    const ts = LAST_RATE_UPDATED ? formatTs(LAST_RATE_UPDATED) : null;
    if(ts){
      if(lang==="zh") return `${mainText}（上次更新：${ts}）`;
      if(lang==="en") return `${mainText} (Last updated: ${ts})`;
      return `${mainText} (Pembaruan terakhir: ${ts})`;
    }
    return mainText;
  }

  // 幣別的小數位數設定
  const CURRENCY_DECIMALS = { 
    IDR: 0, 
    TWD: 2, 
    USD: 2, 
    SGD: 2 
  };

  // ===== 時間格式化工具 =====
  function pad2(n){ return String(n).padStart(2,'0'); }

  function formatTs(dt){
    if(!dt) return "";
    const yy = String(dt.getFullYear()).slice(-2);
    const mm = pad2(dt.getMonth()+1);
    const dd = pad2(dt.getDate());
    const HH = pad2(dt.getHours());
    const MM = pad2(dt.getMinutes());
    const SS = pad2(dt.getSeconds());
    return `${yy}/${mm}/${dd} ${HH}:${MM}:${SS}`;
  }

  // ===== 多語對照表 =====
  const LANGS = {
    zh: {
      title: "酒店業績儀表板",
      filters: { 
        year: "年份", 
        month: "月份", 
        currency: "貨幣", 
        metric: "收入", 
        lang: "語言" 
      },
      chartTitles: { 
        pie: "收入來源", 
        line: "營收/指標趨勢" 
      },
      table: { 
        weekday: "星期", 
        date: "日期", 
        year: "年份", 
        month: "月份", 
        total: "總收入", 
        sum: "合計", 
        roomSold: "已售", 
        rna: "可售", 
        rno: "預售",
        occ: "住房率%", 
        arr: "平均房價"
      },
      weekdays: ['週日','週一','週二','週三','週四','週五','週六'],
      months: m => `${m}月`,
      currencyOpts: [
        { val:"IDR", text:"IDR" },
        { val:"TWD", text:"TWD" },
        { val:"USD", text:"USD" },
        { val:"SGD", text:"SGD" }
      ],
      metricOpts: [
        { val:"Total", text:"總收入" },
        { val:"Room Revenue", text:"房務" },
        { val:"Food Revenue", text:"餐飲" },
        { val:"Beverages", text:"飲料" },
        { val:"Other", text:"其他" },
        { val:"D'Stores", text:"商店" },
        { val:"Banquet", text:"宴會" },
        { val:"Laundry", text:"洗衣" }
      ]
    },

    en: {
      title: "Hotel Performance Dashboard",
      filters: { 
        year: "Year", 
        month: "Month", 
        currency: "Currency", 
        metric: "Revenue", 
        lang: "Language" 
      },
      chartTitles: { 
        pie: "Revenue Sources", 
        line: "Revenue/Indicators Trend" 
      },
      table: { 
        weekday: "Day", 
        date: "Date", 
        year: "Year", 
        month: "Month", 
        total: "Total", 
        sum: "Grand Total", 
        roomSold: "Sold", 
        rna: "RNA", 
        rno: "RNO",
        occ: "Occ%", 
        arr: "Avg Rate"
      },
      weekdays: ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],
      months: m => ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][m-1],
      currencyOpts: [
        { val:"IDR", text:"IDR" },
        { val:"TWD", text:"NTD" },
        { val:"USD", text:"USD" },
        { val:"SGD", text:"SGD" }
      ],
      metricOpts: [
        { val:"Total", text:"Total Revenue" },
        { val:"Room Revenue", text:"Room" },
        { val:"Food Revenue", text:"Food" },
        { val:"Beverages", text:"Beverages" },
        { val:"Other", text:"Other" },
        { val:"D'Stores", text:"Stores" },
        { val:"Banquet", text:"Banquet" },
        { val:"Laundry", text:"Laundry" }
      ]
    },

    id: {
      title: "Dasbor Kinerja Hotel",
      filters: { 
        year: "Tahun", 
        month: "Bulan", 
        currency: "Mata Uang", 
        metric: "Pendapatan", 
        lang: "Bahasa" 
      },
      chartTitles: { 
        pie: "Sumber Pendapatan", 
        line: "Tren Pendapatan/Indikator" 
      },
      table: { 
        weekday: "Hari", 
        date: "Tanggal", 
        year: "Tahun", 
        month: "Bulan", 
        total: "Total", 
        sum: "Jumlah Total", 
        roomSold: "Terjual", 
        rna: "Tersedia", 
        rno: "Anggaran",
        occ: "Hunian%", 
        arr: "Tarif Kamar"
      },
      weekdays: ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'],
      months: m => ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"][m-1],
      currencyOpts: [
        { val:"IDR", text:"IDR" },
        { val:"TWD", text:"TWD" },
        { val:"USD", text:"USD" },
        { val:"SGD", text:"SGD" }
      ],
      metricOpts: [
        { val:"Total", text:"Total" },
        { val:"Room Revenue", text:"Kamar" },
        { val:"Food Revenue", text:"Makanan" },
        { val:"Beverages", text:"Minuman" },
        { val:"Other", text:"Lainnya" },
        { val:"D'Stores", text:"Toko" },
        { val:"Banquet", text:"Pesta" },
        { val:"Laundry", text:"Laundry" }
      ]
    }
  };

  // 自動偵測瀏覽器語言
  let currentLang = (navigator.language.startsWith("id")) ? "id" :
                    (navigator.language.startsWith("en")) ? "en" : "zh";

  // ===== 語言 UI 更新 =====
  function updateLangUI(){
    const L = LANGS[currentLang];
    document.getElementById("pageTitle").textContent = L.title;
    document.getElementById("lblYear").textContent = L.filters.year;
    document.getElementById("lblMonth").textContent = L.filters.month;
    document.getElementById("lblCurrency").textContent = L.filters.currency;
    document.getElementById("lblMetric").textContent = L.filters.metric;
    document.getElementById("lblLang").textContent = L.filters.lang;
    document.getElementById("titlePie").textContent = L.chartTitles.pie;
    document.getElementById("titleLine").textContent = L.chartTitles.line;
    document.getElementById("noteRate").textContent = getNoteText(currentLang);

    // 保留原本選項
    const oldCur = currencySel.value;
    currencySel.innerHTML = L.currencyOpts.map(opt =>
      `<option value="${opt.val}">${opt.text}</option>`
    ).join('');
    if(oldCur) currencySel.value = oldCur;

    // ✅ 改：收入多選（checkbox）用這個重新生成（保留既有勾選）
    const keep = (typeof getSelectedMetrics === 'function') ? getSelectedMetrics() : [];
    initMetricList();
    // 把舊勾選恢復
    if (keep.length) {
      keep.forEach(v=>{
        const cb = metricList.querySelector(`input[value="${v}"]`);
        if (cb) cb.checked = true;
      });
    } else {
      // 第一次進來預設勾 總收入、房務
      ['Total','Room Revenue'].forEach(v=>{
        const cb = metricList.querySelector(`input[value="${v}"]`);
        if (cb) cb.checked = true;
      });
    }

    // 指標（住房率% / 平均房價）多選清單
    document.getElementById("lblMetric2").textContent = (currentLang==='zh') ? "指標" : (currentLang==='en' ? "Indicators" : "Indikator");
    initIndicatorList();  // 生成指標 checkbox
  }

  // ===== 收入欄位定義 =====
  const COLS = [
    { key: 'Room Revenue' },
    { key: 'Food Revenue' },
    { key: 'Beverages' },
    { key: 'Other' },
    { key: "D'Stores" },
    { key: 'Banquet' },
    { key: 'Laundry' }
  ];

  // ===== 額外來源欄位定義 =====
  const EXTRA_COLS = [
    { key: 'Room Sold' },
    { key: 'RNA Actual' },
    { key: 'RNO Budget' }
  ];

  // ===== 顏色配置 =====
  const COLORS = {
    "Total": "#003f7f",        // 總收入 → 深藍
    "Room Revenue": "#5DADE2", // 房務收入 → 淺天藍
    "Food Revenue": "#F39C12", // 餐飲收入 → 橙色
    "Beverages": "#1ABC9C",    // 飲料收入 → 藍綠
    "Other": "#F1C40F",        // 其他收入 → 鮮黃
    "D'Stores": "#C72E3B",     // 商店收入 → 紅色
    "Banquet": "#F78FB3",      // 宴會收入 → 粉紅
    "Laundry": "#9B59B6"       // 洗衣收入 → 紫色
  };

  // ===== 全域變數 =====
  let RAW = [];

  // 抓取主要 DOM 元素
  const yearSel = document.getElementById('yearSel');
  const monthSel = document.getElementById('monthSel');
  const currencySel = document.getElementById('currencySel');

  // 改：收入多選 (button + checkbox)
  const metricBtn = document.getElementById('metricBtn');
  const metricList = document.getElementById('metricList');
  // 指標多選 (button + checkbox)
  const indBtn = document.getElementById('indBtn');
  const indList = document.getElementById('indList');

  const langSel = document.getElementById('langSel');
  const thead = document.getElementById('thead');
  const tbody = document.getElementById('tbody');
  const tfoot = document.getElementById('tfoot');
  const loadingOverlay = document.getElementById('loadingOverlay');

  // ===== 收入多選清單（checkbox） =====
  function initMetricList(){
    const opts = LANGS[currentLang].metricOpts; // 只放金額型指標
    metricList.innerHTML = opts.map(opt =>
      `<label><input type="checkbox" value="${opt.val}"> ${opt.text}</label>`
    ).join('');

    // 預設勾「總收入」「房務」
    ['Total','Room Revenue'].forEach(v=>{
      const cb = metricList.querySelector(`input[value="${v}"]`);
      if(cb) cb.checked = true;
    });

    // 勾選變動即時更新
    metricList.querySelectorAll('input').forEach(cb=>{
      cb.addEventListener('change', render);
    });

    // 下拉開關（只綁一次，不要重複）
    if(!metricBtn._bound){
      metricBtn.addEventListener('click', (e)=>{
        e.stopPropagation(); // 不要冒泡
        metricBtn.parentElement.classList.toggle('show');
      });
      metricBtn._bound = true;
    }

    // 點擊外部區域 → 自動收合（只綁一次）
    if (!window._metricDocBound) {
      document.addEventListener('click', (e)=>{
        if(!metricBtn.parentElement.contains(e.target)){
          metricBtn.parentElement.classList.remove('show');
        }
      });
      window._metricDocBound = true;
    }
  }

  function getSelectedMetrics(){
    return Array.from(metricList.querySelectorAll('input:checked'))
                .map(cb => cb.value);
  }

  // ===== 指標多選清單（住房率% / 平均房價） =====
  function initIndicatorList(){
    // 顯示用的文字（跟語系連動）
    const occText = (LANGS[currentLang].table.occ || "Occ%");
    const arrText = (LANGS[currentLang].table.arr || "Avg Rate");

    // 只有兩個選項：OccRate / AvgRate
    indList.innerHTML = [
      `<label><input type="checkbox" value="OccRate"> ${occText}</label>`,
      `<label><input type="checkbox" value="AvgRate"> ${arrText}</label>`
    ].join('');

    // 預設兩個都勾
    indList.querySelectorAll('input').forEach(cb=> cb.checked = true);

    // 勾選變動 → 重新繪圖
    indList.querySelectorAll('input').forEach(cb=>{
      cb.addEventListener('change', render);
    });

    // 下拉開關（只綁一次）
    if(!indBtn._bound){
      indBtn.addEventListener('click', (e)=>{
        e.stopPropagation();
        indBtn.parentElement.classList.toggle('show');
      });
      indBtn._bound = true;
    }

    // 點擊外部區域 → 自動收合（只綁一次）
    if (!window._indDocBound) {
      document.addEventListener('click', (e)=>{
        if(!indBtn.parentElement.contains(e.target)){
          indBtn.parentElement.classList.remove('show');
        }
      });
      window._indDocBound = true;
    }
  }

  function getSelectedIndicators(){
    return Array.from(indList.querySelectorAll('input:checked'))
                .map(cb => cb.value);
  }

  // 圖表物件 (稍後初始化)
  let trendChart, pieChart;

  // ===== 工具函式 =====

  // 抓取 JSON 資料
  async function fetchJSON(url){
    const res = await fetch(url, { cache:'no-store' });
    if(!res.ok) throw new Error('HTTP ' + res.status);
    return await res.json();
  }

  // 轉換字串 → 數字
  function toNumber(v){ 
    if(!v) return 0; 
    return parseFloat(String(v).replace(/[,\\s]/g,'').replace(/[^0-9.-]/g,'')) || 0; 
  }

  // 幣別轉換 (IDR → cur)
  function idrTo(cur, amt){ 
    return amt / (RATES[cur] || 1); 
  }

  // 格式化金額
  function formatCurrency(x, cur){ 
    const d = CURRENCY_DECIMALS[cur] || 0; 
    return Number(x).toLocaleString(
      currentLang==="en" ? "en-US" : "zh-TW",
      { minimumFractionDigits:d, maximumFractionDigits:d }
    ); 
  }

  // 日期字串解析 (yyyy-mm-dd → 物件)
  function parseYMD(dateStr){ 
    const d = new Date(dateStr); 
    if(isNaN(d)) return null; 
    return { 
      y: d.getFullYear(), 
      m: d.getMonth()+1, 
      d: d.getDate(), 
      wd: d.getDay(), 
      str: `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}` 
    }; 
  }

  // 月份標籤
  function monthLabel(m){ 
    return LANGS[currentLang].months(m); 
  }

  // 判斷模式
  function currentMode(){ 
    return (yearSel.value!=='ALL' && monthSel.value!=='ALL') ? 'daily':'agg'; 
  }

  // 過濾資料
  function filterData(){ 
    const yv = yearSel.value, mv = monthSel.value; 
    return RAW.filter(r => { 
      const t = parseYMD(r.Date); 
      if(!t) return false; 
      return (yv==='ALL'||t.y==yv) && (mv==='ALL'||t.m==mv); 
    }); 
  }

  // ===== 自訂外掛：在 yPercent 軸的 100 上方標註 "(%)" =====
  const percentNotePlugin = {
    id: 'percentNote',
    afterDraw(chart) {
      const y = chart.scales?.yPercent;
      if (!y) return;
      const ctx = chart.ctx;

      // 100 對應到的 y 像素位置（越小越上面）
      const y100 = y.getPixelForValue(100);

      // 在右側軸的內側，100 的稍上方放 "(Occ%)"
      ctx.save();
      ctx.fillStyle = '#666';
      ctx.font = '12px system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Noto Sans", sans-serif';
      ctx.textAlign = 'right';
      ctx.textBaseline = 'bottom';
      ctx.fillText('(Occ%)', y.right - 0, y100 - 22);
      ctx.restore();
    }
  };

  // ===== 圖表渲染 =====
  function renderCharts(rows){
    const cur = currencySel.value;
    const selectedMetrics = getSelectedMetrics(); // ✅ 多選收入

    const mode = currentMode();
    const L = LANGS[currentLang];
    let labels = [], dayRows = [], groups = [];

    if(mode === 'daily'){
      const yv = Number(yearSel.value), mv = Number(monthSel.value);
      dayRows = rows
        .filter(r => { const t = parseYMD(r.Date); return t && t.y === yv && t.m == mv; })
        .sort((a,b) => parseYMD(a.Date).d - parseYMD(b.Date).d);
      labels = dayRows.map(r => parseYMD(r.Date).d + "");
    } else {
      const map = new Map();
      for(const r of rows){
        const t = parseYMD(r.Date); if(!t) continue;
        const key = `${t.y}-${t.m}`;
        if(!map.has(key)) map.set(key,{
          y: t.y, m: t.m,
          totals: COLS.reduce((o,c)=>(o[c.key]=0,o),{}),
          extras: EXTRA_COLS.reduce((o,c)=>(o[c.key]=0,o),{})
        });
        const g = map.get(key);
        for(const c of COLS) g.totals[c.key] += toNumber(r[c.key]);
        for(const c of EXTRA_COLS) g.extras[c.key] += toNumber(r[c.key]);
      }
      groups = Array.from(map.values()).sort((a,b)=>a.y-b.y || a.m-b.m);
      labels = groups.map(g => monthLabel(g.m));
    }

    const datasets = [];

    // 多選收入 datasets
    for(const metric of selectedMetrics){
      let data = [];
      if(mode==='daily'){
        data = dayRows.map(r=>{
          if(metric==="Total"){
            return idrTo(cur, COLS.reduce((s,c)=>s+toNumber(r[c.key]),0));
          } else {
            return idrTo(cur, toNumber(r[metric]));
          }
        });
      } else {
        data = groups.map(g=>{
          if(metric==="Total"){
            return idrTo(cur, COLS.reduce((s,c)=>s+g.totals[c.key],0));
          } else {
            return idrTo(cur, g.totals[metric]);
          }
        });
      }

      const label = LANGS[currentLang].metricOpts.find(m=>m.val===metric)?.text || metric;
      const color = COLORS[metric] || "#666";

      // Y 軸邏輯
      let yAxisID = "yRight";
      if(metric==="Total" || metric==="Room Revenue") yAxisID = "yLeft";
      if(metric==="OccRate") yAxisID = "yPercent";

      datasets.push({
        label, data,
        borderColor: color,
        backgroundColor: color+"40",
        fill:false,
        yAxisID
      });
    }

    // 指標（多選：OccRate / AvgRate）datasets
    const inds = getSelectedIndicators();
    for(const ind of inds){
      let dataI = [];
      if(mode === 'daily'){
        dataI = dayRows.map(r=>{
          if(ind==="OccRate"){
            const rs = toNumber(r['Room Sold']);
            const ra = toNumber(r['RNA Actual']);
            return (ra>0) ? (rs/ra*100) : 0;        // 百分比，不轉幣別
          } else { // AvgRate
            const rs = toNumber(r['Room Sold']);
            return (rs>0) ? idrTo(cur, toNumber(r["Room Revenue"])/rs) : 0;  // 金額，轉成當前幣別
          }
        });
      } else {
        dataI = groups.map(g=>{
          if(ind==="OccRate"){
            const rs = g.extras['Room Sold'];
            const ra = g.extras['RNA Actual'];
            return (ra>0) ? (rs/ra*100) : 0;
          } else { // AvgRate
            const rs = g.extras['Room Sold'];
            return (rs>0) ? idrTo(cur, g.totals['Room Revenue']/rs) : 0;
          }
        });
      }
      const labelI = (ind==="OccRate") ? (LANGS[currentLang].table.occ || "Occ%")
                                       : (LANGS[currentLang].table.arr || "Avg Rate");
      const colorI = (ind==="OccRate") ? "#3d3d3d" : "#b3b3b3";  // 住房率%灰、平均房價深灰
      const yAxisID = (ind==="OccRate") ? "yPercent" : "yRight";
      datasets.push({
        label: labelI,
        data: dataI,
        borderColor: colorI,
        backgroundColor: colorI + "40",
        fill: false,
        yAxisID
      });
    }

    // 建立折線圖 trendChart
    // 註冊外掛（只註冊一次）
    if (!window._percentNoteRegistered) {
      Chart.register(percentNotePlugin);
      window._percentNoteRegistered = true;
    }

    if (trendChart) trendChart.destroy();

    // 先判斷是否為手機寬度（更準）
    const isMobile = window.matchMedia('(max-width: 768px)').matches;

    // 桌機/手機不同刻度數（桌機=10、手機=8）
    const TICK_LIMIT = isMobile ? 8 : 10;

    trendChart = new Chart(document.getElementById("trendChart"), {
      type: "line",
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: true,           // 交給比例算高度
        aspectRatio: isMobile ? 1.2 : 2,     // 手機高一點，桌機維持 2:1
        layout: { padding: { left:16, right:16, top:4, bottom:4 } },

        plugins:{
          legend:{ 
            display:true,
            labels:{
              boxWidth: 10,
              boxHeight: 10,
              font:{ size: 12 }
            }
          },
          tooltip:{
            callbacks:{
              label: function(ctx){
                const ds = ctx.dataset;
                const val = ctx.parsed.y;
                // 住房率%（右側 % 軸）
                if (ds.yAxisID === 'yPercent') {
                  const xLabel = ctx.chart.data.labels[ctx.dataIndex] || '';
                  return `${xLabel} ${Number(val).toFixed(2)}%`;
                }
              }
            }
          },
          title: {
            display: true,
            text: "Y-axis多軸：L=Total/Room、R=Others...",
            align: "start"
          }
        },
        scales:{
          yLeft: { 
            type:'linear',
            position:'left',
            beginAtZero:true,
            suggestedMax: undefined,
            grace: '5%',
            ticks: {
              callback: function(value) {
                if (value >= 1_000_000_000) {
                  const v = value/1_000_000_000;
                  return (Number.isInteger(v) ? v : v.toFixed(1)) + "B";
                }
                if (value >= 1_000_000) {
                  const v = value/1_000_000;
                  return (Number.isInteger(v) ? v : v.toFixed(1)) + "M";
                }
                if (value >= 1_000) {
                  return (value/1_000).toFixed(0) + "K";
                }
                return value;
              },
              maxTicksLimit: TICK_LIMIT,
              font: { size: 12 },
              padding: 0
            }
          },
          yRight:{ 
            type:'linear',
            position:'right',
            beginAtZero:true,
            grid:{ drawOnChartArea:false },
            grace: '5%',
            ticks: {
              callback: function(value) {
                if (value >= 1_000_000_000) {
                  const v = value/1_000_000_000;
                  return (Number.isInteger(v) ? v : v.toFixed(1)) + "B";
                }
                if (value >= 1_000_000) {
                  const v = value/1_000_000;
                  return (Number.isInteger(v) ? v : v.toFixed(1)) + "M";
                }
                if (value >= 1_000) {
                  return (value/1_000).toFixed(0) + "K";
                }
                return value;
              },
              maxTicksLimit: TICK_LIMIT,
              font: { size: 12 },
              padding: 0
            }
          },
          yPercent:{
            type:'linear',
            position:'right',
            min:0,
            max:100,
            grid:{ drawOnChartArea:false },
            afterBuildTicks(scale){
              const ticks = [];
              for(let v=0; v<=100; v+=10) ticks.push({ value:v });
              scale.ticks = ticks;
            },
            ticks:{
              autoSkip: false,
              callback: v => v,
              maxRotation: 0,
              minRotation: 0
            },
            grace: 6
          }
        }
      }
    });

    // === 圓餅圖 ===
    let totals = COLS.reduce((o,c)=>(o[c.key]=0,o),{});
    rows.forEach(r => { 
      for(const c of COLS) totals[c.key] += idrTo(cur, toNumber(r[c.key])); 
    });

    const pieLabels = COLS.map(c => {
      const label = LANGS[currentLang].metricOpts.find(m => m.val === c.key)?.text || c.key;
      const value = totals[c.key];
      return `${label} (${formatCurrency(value, cur)})`;
    });

    const pieKeys   = COLS.map(c => c.key);
    const pieData   = pieKeys.map(k => totals[k]);
    const pieColors = pieKeys.map(k => COLORS[k]);

    if(pieChart) pieChart.destroy();
    pieChart = new Chart(document.getElementById("pieChart"), {
      type: "pie",
      data: { 
        labels: pieLabels, 
        datasets: [{ data: pieData, backgroundColor: pieColors }] 
      },
      options:{ 
        responsive: true, 
        onClick: (evt, elements) => {
          if(!elements.length) return;
          const idx = elements[0].index;
          // 點圓餅圖 → 切換收入清單的勾選狀態
          const key = pieKeys[idx];
          const cb = metricList.querySelector(`input[value="${key}"]`);
          if(cb){
            cb.checked = !cb.checked;
            render();
          }
        },
        plugins:{ 
          legend:{ 
            position:"right", 
            labels:{ boxWidth:12, font:{size:14} } 
          } 
        } 
      }
    });

    // 在標題顯示總收入
    const totalIncome = pieData.reduce((a,b)=>a+b,0);
    document.getElementById("titlePie").textContent = 
      LANGS[currentLang].chartTitles.pie + 
      " (" + LANGS[currentLang].table.total + "：" + cur + " " + formatCurrency(totalIncome, cur) + ")";
  } // ← 結束 renderCharts()

  // ===== 表格渲染 =====
  function render(){
    const rows = filterData();
    const mode = currentMode();
    const cur  = currencySel.value;
    const L    = LANGS[currentLang];

    // 清空表格
    thead.innerHTML = '';
    tbody.innerHTML = '';
    tfoot.innerHTML = '';

    const isDaily = (mode === 'daily');

    // 小工具：建立 <th>
    function addTh(tr, text, {num=false, extra=false} = {}){
      const th = document.createElement('th');
      th.textContent = text;
      if (num)   th.classList.add('num');
      if (extra) th.classList.add('mobile-extra');
      tr.appendChild(th);
    }

    // 小工具：建立 <td>
    function addTd(tr, text, {num=false, extra=false, calc=false} = {}){
      const td = document.createElement('td');
      td.textContent = text;
      if (num)   td.classList.add('num');
      if (extra) td.classList.add('mobile-extra');
      if (calc)  td.classList.add('calc');
      tr.appendChild(td);
    }

    // ===== 建立表頭 =====
    const trh = document.createElement('tr');

    if (isDaily) {
      // 星期 / 日期 一律顯示
      addTh(trh, L.table.weekday, { num:false, extra:false });
      addTh(trh, L.table.date,    { num:false, extra:false });

      // 房務 / 其他收入欄位
      COLS.forEach(c => {
        const label = L.metricOpts.find(m => m.val === c.key)?.text || c.key;
        const isRoom = (c.key === 'Room Revenue'); // 房務欄位
        // 手機預設：只顯示房務，其它收入標成 mobile-extra
        addTh(trh, label, { num:true, extra: !isRoom });
      });

      // 總收入：主要欄位（不隱藏）
      addTh(trh, L.table.total, { num:true, extra:false });

      // Sold / RNA / RNO：額外欄位（mobile-extra）
      addTh(trh, L.table.roomSold, { num:true, extra:true });
      addTh(trh, L.table.rna,      { num:true, extra:true });
      addTh(trh, L.table.rno,      { num:true, extra:true });

      // 住房率%、平均房價：主要欄位（不隱藏）
      addTh(trh, L.table.occ, { num:true, extra:false });
      addTh(trh, L.table.arr, { num:true, extra:false });
    } else {
      // 年 / 月 一律顯示
      addTh(trh, L.table.year,  { num:false, extra:false });
      addTh(trh, L.table.month, { num:false, extra:false });

      // 房務 / 其他收入欄位
      COLS.forEach(c => {
        const label = L.metricOpts.find(m => m.val === c.key)?.text || c.key;
        const isRoom = (c.key === 'Room Revenue');
        addTh(trh, label, { num:true, extra: !isRoom });
      });

      // 總收入：主要欄位
      addTh(trh, L.table.total, { num:true, extra:false });

      // Sold / RNA / RNO：額外欄位
      addTh(trh, L.table.roomSold, { num:true, extra:true });
      addTh(trh, L.table.rna,      { num:true, extra:true });
      addTh(trh, L.table.rno,      { num:true, extra:true });

      // 住房率%、平均房價：主要欄位
      addTh(trh, L.table.occ, { num:true, extra:false });
      addTh(trh, L.table.arr, { num:true, extra:false });
    }

    thead.appendChild(trh);

    // ===== 表格內容 =====
    let grand = COLS.reduce((o,c)=>(o[c.key]=0,o),{}),
        grandTotal = 0;
    grand['Room Sold']  = 0;
    grand['RNA Actual'] = 0;
    grand['RNO Budget'] = 0;

    if (isDaily) {
      const yv = Number(yearSel.value), mv = monthSel.value;
      const dayRows = rows
        .filter(r => {
          const t = parseYMD(r.Date);
          return t && t.y === yv && (mv === "ALL" || t.m == mv);
        })
        .sort((a,b) => parseYMD(a.Date).d - parseYMD(b.Date).d);

      for (const r of dayRows) {
        const t = parseYMD(r.Date);
        const tr = document.createElement('tr');

        // 星期 / 日期（主要欄位）
        addTd(tr, L.weekdays[t.wd], { num:false, extra:false });
        addTd(tr, t.str,            { num:false, extra:false });

        // 房務 / 其他收入
        let rowTotal = 0;
        for (const c of COLS) {
          const v = toNumber(r[c.key]);
          rowTotal += v;
          grand[c.key] += v;

          const isRoom = (c.key === 'Room Revenue');
          addTd(tr, formatCurrency(idrTo(cur, v), cur), {
            num: true,
            extra: !isRoom
          });
        }

        grandTotal += rowTotal;
        addTd(tr, formatCurrency(idrTo(cur, rowTotal), cur), {
          num: true,
          calc: true,
          extra: false   // 總收入：主要欄位
        });

        // Sold / RNA / RNO
        const rs = toNumber(r['Room Sold']);
        const ra = toNumber(r['RNA Actual']);
        const rb = toNumber(r['RNO Budget']);

        addTd(tr, rs || 0, { num:true, extra:true });
        addTd(tr, ra || 0, { num:true, extra:true });
        addTd(tr, rb || 0, { num:true, extra:true });

        grand['Room Sold']  += rs;
        grand['RNA Actual'] += ra;
        grand['RNO Budget'] += rb;

        // 住房率% / 平均房價（主要欄位）
        const occ = (ra > 0) ? (rs/ra*100).toFixed(1) : 0;
        const arr = (rs > 0) ? idrTo(cur, toNumber(r["Room Revenue"]) / rs) : 0;

        addTd(tr, `${occ}%`, { num:true, calc:true, extra:false });
        addTd(tr, formatCurrency(arr, cur), { num:true, calc:true, extra:false });

        tbody.appendChild(tr);
      }
    } else {
      // 月/年匯總模式
      const map = new Map();
      for (const r of rows) {
        const t = parseYMD(r.Date);
        if (!t) continue;
        const key = `${t.y}-${t.m}`;
        if (!map.has(key)) {
          map.set(key, {
            Year: t.y,
            Month: t.m,
            totals: COLS.reduce((o,c)=>(o[c.key]=0,o),{}),
            extras: EXTRA_COLS.reduce((o,c)=>(o[c.key]=0,o),{})
          });
        }
        const g = map.get(key);
        for (const c of COLS)       g.totals[c.key] += toNumber(r[c.key]);
        for (const c of EXTRA_COLS) g.extras[c.key] += toNumber(r[c.key]);
      }

      const groups = Array.from(map.values())
        .sort((a,b)=> a.Year - b.Year || a.Month - b.Month);

      for (const g of groups) {
        const tr = document.createElement('tr');

        // 年 / 月
        addTd(tr, g.Year,             { num:false, extra:false });
        addTd(tr, monthLabel(g.Month),{ num:false, extra:false });

        // 房務 / 其他收入
        let rowTotal = 0;
        for (const c of COLS) {
          const v = g.totals[c.key];
          rowTotal += v;
          grand[c.key] += v;

          const isRoom = (c.key === 'Room Revenue');
          addTd(tr, formatCurrency(idrTo(cur, v), cur), {
            num: true,
            extra: !isRoom
          });
        }

        grandTotal += rowTotal;
        addTd(tr, formatCurrency(idrTo(cur, rowTotal), cur), {
          num: true,
          calc: true,
          extra: false    // 總收入：主要欄位
        });

        // Sold / RNA / RNO
        const rs = g.extras['Room Sold'];
        const ra = g.extras['RNA Actual'];
        const rb = g.extras['RNO Budget'];

        addTd(tr, rs || 0, { num:true, extra:true });
        addTd(tr, ra || 0, { num:true, extra:true });
        addTd(tr, rb || 0, { num:true, extra:true });

        grand['Room Sold']  += rs;
        grand['RNA Actual'] += ra;
        grand['RNO Budget'] += rb;

        // 住房率% / 平均房價（主要欄位）
        const occ = (ra > 0) ? (rs/ra*100).toFixed(1) : 0;
        const arr = (rs > 0) ? idrTo(cur, g.totals['Room Revenue'] / rs) : 0;

        addTd(tr, `${occ}%`, { num:true, calc:true, extra:false });
        addTd(tr, formatCurrency(arr, cur), { num:true, calc:true, extra:false });

        tbody.appendChild(tr);
      }
    }

    // ===== 表尾合計 =====
    const trf = document.createElement('tr');

    // 「合計」這格要 colspan = 2
    const tdSum = document.createElement('td');
    tdSum.colSpan = 2;
    tdSum.textContent = L.table.sum;
    trf.appendChild(tdSum);

    // 各收入欄位合計
    COLS.forEach(c => {
      const isRoom = (c.key === 'Room Revenue');
      const td = document.createElement('td');
      td.textContent = formatCurrency(idrTo(cur, grand[c.key]), cur);
      td.classList.add('num');
      if (!isRoom) td.classList.add('mobile-extra');
      trf.appendChild(td);
    });

    // 總收入合計（主要欄位）
    const tdTotal = document.createElement('td');
    tdTotal.textContent = formatCurrency(idrTo(cur, grandTotal), cur);
    tdTotal.classList.add('num','calc');
    trf.appendChild(tdTotal);

    // Sold / RNA / RNO 合計（額外欄位）
    ['Room Sold','RNA Actual','RNO Budget'].forEach(k => {
      const td = document.createElement('td');
      td.textContent = grand[k] || 0;
      td.classList.add('num','mobile-extra');
      trf.appendChild(td);
    });

    // 合計的 住房率% / 平均房價（主要欄位）
    const totalRS = grand['Room Sold']  || 0;
    const totalRA = grand['RNA Actual'] || 0;
    const totalOcc = (totalRA > 0) ? (totalRS/totalRA*100).toFixed(1) : 0;
    const totalArr = (totalRS > 0) ? idrTo(cur, grand['Room Revenue']/totalRS) : 0;

    addTd(trf, `${totalOcc}%`, { num:true, calc:true, extra:false });
    addTd(trf, formatCurrency(totalArr, cur), { num:true, calc:true, extra:false });

    tfoot.appendChild(trf);

    // 更新圖表
    renderCharts(rows);
  }


  // ===== 初始化 =====
  async function init(){
    try {
      RAW = await fetchJSON(DATA_URL);
    } catch(e){
      console.error("讀取資料失敗:", e);
      loadingOverlay.innerHTML = "<p>讀取資料失敗，請檢查 API URL</p>";
      // 失敗的時候也把遮罩拿掉，避免整頁不能點
      loadingOverlay.style.display = "none";
      return;
    }

    // 填入年份 / 月份
    const years=[...new Set(RAW.map(r=>parseYMD(r.Date)?.y).filter(Boolean))].sort();
    yearSel.innerHTML = `<option value="ALL">ALL</option>` + years.map(y=>`<option>${y}</option>`).join('');
    monthSel.innerHTML = `<option value="ALL">ALL</option>` + Array.from({length:12},(_,i)=>`<option value="${i+1}">${monthLabel(i+1)}</option>`).join('');
    // 預設值：今年 + ALL 月份
    const thisYear = new Date().getFullYear();
    yearSel.value = thisYear;
    monthSel.value = "ALL";

    updateLangUI();
    initMetricList();   // ✅ 新增
    render();

    // 隱藏 loading 畫面
    loadingOverlay.style.display="none";
  }

  // ===== 事件監聽 =====
  yearSel.addEventListener('change', render);
  monthSel.addEventListener('change', render);
  currencySel.addEventListener('change', render);

  langSel.addEventListener('change', e=>{
    currentLang = e.target.value;
    updateLangUI();
    render();
  });

  // 每 30 分鐘自動更新匯率
  setInterval(updateRates, 30*60*1000);

  // 頁面載入完成 → 初始化
  document.addEventListener('DOMContentLoaded', init);

  // 手機版：展開/收合欄位按鈕
  const toggleColsBtn = document.getElementById('toggleColsBtn');
  if (toggleColsBtn) {
    toggleColsBtn.addEventListener('click', () => {
      const on = document.body.classList.toggle('show-more-cols');
      toggleColsBtn.textContent = on ? '收合欄位 ▲' : '更多欄位 ▼';
    });
  }

  // 視窗尺寸改變 → 重新渲染（150ms 防抖）
  let _rzTimer = null;
  window.addEventListener('resize', () => {
    clearTimeout(_rzTimer);
    _rzTimer = setTimeout(() => render(), 150);
  });


    // === 手機版：三條槓 + 側邊欄邏輯 ===
  document.addEventListener('DOMContentLoaded', () => {
    const menuToggle  = document.querySelector('.menu-toggle');
    const sideOverlay = document.getElementById('sideOverlay');
    const filters     = document.querySelector('.filters');

    // 點三條槓 → 開 / 關 側邊選單
    if (menuToggle) {
      menuToggle.addEventListener('click', (e) => {
        e.stopPropagation();                   // 不要往上冒泡
        document.body.classList.toggle('menu-open');
      });
    }

// 點黑色遮罩 → 關閉側邊選單
    if (sideOverlay) {
      sideOverlay.addEventListener('click', () => {
        document.body.classList.remove('menu-open');
      });
    }

    // 點側邊欄內容本身，不要關閉（讓 select / dropdown 可以正常操作）
    if (filters) {
      filters.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    }
  });
</script>


  <!-- 備註說明區 -->
  <div class="note" style="margin:20px 0 40px 0; font-size:13px; color:#555; padding-left:16px;">
    <b>備註：</b><br/>
    1. 以下欄位為系統計算，並非直接帶入試算表資料：<br/>
    &nbsp;&nbsp;&nbsp;• 總收入 (Total Revenue) = 房務收入Room + 餐飲Food + 飲料Beverages + 其他Other + 商店Stores + 宴會Banquet + 洗衣Laundry<br/>
    &nbsp;&nbsp;&nbsp;• 住房率% (Occ%) = (已售Sold ÷ 可售RNA) × 100%<br/>
    &nbsp;&nbsp;&nbsp;• 平均房價 (Avg Rate) = 房務收入Room Revenue ÷ 已售Sold<br/>
    <br/>
    2. 匯率更新方式與頻率：<br/>
    &nbsp;&nbsp;&nbsp;• 匯率來源：open.er-api.com 即時 API<br/>
    &nbsp;&nbsp;&nbsp;• 使用者可手動點擊「Update」按鈕立即更新<br/>
    &nbsp;&nbsp;&nbsp;• 系統會自動每 30 分鐘更新一次<br/>
    &nbsp;&nbsp;&nbsp;• 若 API 錯誤或網路異常，系統會保留上次成功的匯率
  </div>

</body>
</html>
